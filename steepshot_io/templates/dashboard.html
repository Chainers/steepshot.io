{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}?v=20170707">
    <script src="{% static 'js/plotly-latest.min.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>
<body>
<span id="error_msg"></span>
<div class="form-dashboard">
<form method="post">
  <input type="radio" name="myRadio" id="steem" value="steem" class="dashboard_radio" onclick="check_radio(this.value)" checked> Steem
  <input type="radio" name="myRadio" id="golos" value="golos" class="dashboard_radio" onclick="check_radio(this.value)"> Golos
  <input type="radio" name="myRadio" value="sum" id="sum" class="dashboard_radio" onclick="check_radio(this.value)"> Sum
</form>

<form method="post" id="date-form-choice">
{% csrf_token %}
  <button type="button"  id="btn_7" value="7"  class="btn" onclick="data_from_button(this)">7 days</button>
  <button type="button"  id="btn_30" value="30" class="btn" onclick="data_from_button(this)">30 days</button>
  <button type="button"  id="btn_90" value="90"  class="btn" onclick="data_from_button(this)">3 months</button>
</form>

<form method="get" id="date-form">
    <span>Date from </span><input type="date" name="date_from">
    <span>Date to </span><input type="date" name="date_to">
    <input type="button" class="btn" value="show" onclick="data_from_input(this.form)">
</form>
<div><span id="error">Date to must be less than Date now</span></div>
</div>

<div class="grid-dashboard">
    <div id="graph1"></div>
</div>
<div class="grid-dashboard">
    <div id="graph2"></div>
</div>
<div class="grid-dashboard">
    <div id="graph3"></div>
</div>
<div class="grid-dashboard">
    <div id="graph4"></div>
</div>
<script>
    var class_btn = $("#btn_7");
    class_btn.css({
        background: '#fe6637',
        color: '#fff'
    });


    var name_data, data_graph;
    function checkNameRatio (name_data) {
        if (name_data==='golos'){
            data_graph = 'data_glos'
        }
        else if (name_data==='sum'){
            data_graph='data_sum'
            }
        else
            data_graph='data_steem';
    }
    checkNameRatio(name_data);
    function check_radio(platform) {
        name_data = document.getElementsByName("myRadio").value = platform;
        checkNameRatio(name_data);
        drawGraphs(data_graph_1);
        drawGraphs(data_graph_2);
        drawGraphs(data_graph_3);
        drawGraphs(data_graph_4);
        }
    var api_query = {'date_to': null,
                    'date_from': null};
    var data_graph_1, data_graph_2, data_graph_3, data_graph_4;
    function get_data(api_query) {

        if (api_query['date_to'] != null) {
            var date_from = '&date_from=' + api_query['date_from'];
            var date_to = '&date_to=' + api_query['date_to'];
        }
        else {
            var date_from = '';
            var date_to = '';
        }
        var api = ['?graph=1', '?graph=2', '?graph=3', '?graph=4'];
        api.forEach(function(item, i, arr) {
        $.getJSON('.'+ item+date_to+date_from, function (data) {
        if (i==0) {
             data_graph_1 = data;
             drawGraphs(data_graph_1);

        }
        else if (i==1){
            data_graph_2 = data;
            drawGraphs(data_graph_2);


        }
        else if (i==2){
            data_graph_3 = data;
            drawGraphs(data_graph_3);

        }
        else if (i==3){
            data_graph_4 = data;
            drawGraphs(data_graph_4);

        }
    })})}
    function drawGraphs(data) {
        console.log(data);
        var chart_div = document.getElementById(data['name_div']);
        var dataY1 = {
            'x' : data['date'],
            'y': data[data_graph][0],
             type: 'scatter',
             name: data['name_data_line_1']

        };
        if (data[data_graph].length == 2) {
            var dataY2 = {
                'x': data['date'],
                'y': data[data_graph][1],
                type: 'scatter',
                name: data['name_data_line_2']
            };
             data_res = [dataY1, dataY2];
        }
        else {
             data_res = [dataY1]
        }
        console.log(dataY1);
        var layout = {xaxis: {
            tickformat: "%Y-%m-%d"
        },
                    title: data['title'],
                    hovermode: 'closest',
                    autosize: true
                };
        Plotly.newPlot(chart_div, data_res, layout);
    }
    get_data(api_query);
    function data_from_input(form) {
        var elems = form.elements;
        api_query['date_to'] = elems.date_to.value;
        api_query['date_from'] = elems.date_from.value;
        var check_date = new Date();
        if (format_date(check_date) <= api_query['date_to']) {
            $('#error').css('display', 'block');
        }
    else {
            $('#error').css('display', 'none');
            get_data(api_query);
        }
    }
    function format_date(date){
        var yyyy = date.getFullYear();
        var mm = parseInt(date.getMonth())+1;
        var dd = date.getDate();
        if(dd<10)
        {
            dd='0'+dd;
        }
        if(mm<10)
        {
            mm='0'+mm;
        }
        return yyyy+'-'+mm+'-'+dd
    }


    function click_btn(btn) {
        if (window.class_btn.attr('id') !== btn.id) {
            $(btn).css({
            background: '#fe6637',
            color: '#fff'
        });
          $(class_btn).css({
              background: '#f6f6fb',
              color: '#fe6637'
          });
          window.class_btn = $('#' + btn.id);
        }}

    function data_from_button(btn) {
        var date_to = new Date();
        var date_from = new Date();
        date_to.setDate(date_to.getDate() - 1);
        if (btn.value === '90'){
            date_from.setDate(date_from.getDate() - 90 - 1);
        }
        else if (btn.value==='7'){
            date_from.setDate(date_from.getDate() - 7 - 1);
        }
        else
        {
            date_from.setDate(date_from.getDate() - 30 - 1);
        }
        date_from = format_date(date_from);
        date_to = format_date(date_to);
        api_query['date_to'] = date_to;
        api_query['date_from'] = date_from;
        click_btn(btn);
        get_data(api_query);
    }

</script>
</body>
</html>
